<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Spring Data JPA 多条件连表查询 (2022 更新) | The Coding Notes</title><meta name=keywords content="Java,Kotlin,Spring,JPA"><meta name=description content="痛点 项目中使用 Spring Data JPA 作为 ORM 框架的时候，实体映射非常方便。Spring Data Repository 的顶层抽象完全解决单实体的查询，面对单实体的复杂查询，也能使用 JpaSpecificationExecutor<T> 构造 Specification<T> 轻松应对。
而对于后台管理报表查询需求来说，需要进行连表多条件动态查询的时候，就显得无从下手。因为它并不像 MyBatis 一样能够在 XML 文件中写出动态 SQL 语句。
尽管可以使用 EntityManager 动态拼接原生 SQL 语句，但是该方法返回值为 ResultSet ，也就是说查出来的实体映射关系需要手动映射（😢这样不太优雅，已经定义出实体，还需要自己去映射）。
所以，本文的目的是，在现有实体关系的基础上，结合 Specification<T> 记录下 Spring Data JPA 多条件动态连表查询操作，以及其中的踩坑和优化。
想要直接看结论的，请看这篇 Spring Data JPA 动态多条件连表查询最佳实践。
基础操作 那么，让我们开始进入代码操作。【本文所有代码在此】
前置说明 相关依赖 Java 11 SpringBoot 2.4.2 build.gradle
plugins { id 'org.springframework.boot' version '2.4.2' id 'io.spring.dependency-management' version '1.0.11.RELEASE' id 'java' } dependencies { implementation 'org.springframework.boot:spring-boot-starter-data-jpa' compileOnly 'org.projectlombok:lombok' runtimeOnly 'mysql:mysql-connector-java' annotationProcessor 'org."><meta name=author content="Lex Cao"><link rel=canonical href=https://lexcao.io/zh/posts/spring-data-jpa-join-table/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b1540977aafa12664148f5c3a53472ca37129bcd9cbbdf6f6336462e0e1e9ecb.css integrity="sha256-sVQJd6r6EmZBSPXDpTRyyjcSm82cu99vYzZGLg4enss=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://lexcao.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lexcao.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lexcao.io/favicon-32x32.png><link rel=apple-touch-icon href=https://lexcao.io/apple-touch-icon.png><link rel=mask-icon href=https://lexcao.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.104.0"><link rel=alternate hreflang=zh href=https://lexcao.io/zh/posts/spring-data-jpa-join-table/><script async src="https://www.googletagmanager.com/gtag/js?id=G-DDVMDVDZMH"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DDVMDVDZMH",{anonymize_ip:!1})}</script><meta property="og:title" content="Spring Data JPA 多条件连表查询 (2022 更新)"><meta property="og:description" content="痛点 项目中使用 Spring Data JPA 作为 ORM 框架的时候，实体映射非常方便。Spring Data Repository 的顶层抽象完全解决单实体的查询，面对单实体的复杂查询，也能使用 JpaSpecificationExecutor<T> 构造 Specification<T> 轻松应对。
而对于后台管理报表查询需求来说，需要进行连表多条件动态查询的时候，就显得无从下手。因为它并不像 MyBatis 一样能够在 XML 文件中写出动态 SQL 语句。
尽管可以使用 EntityManager 动态拼接原生 SQL 语句，但是该方法返回值为 ResultSet ，也就是说查出来的实体映射关系需要手动映射（😢这样不太优雅，已经定义出实体，还需要自己去映射）。
所以，本文的目的是，在现有实体关系的基础上，结合 Specification<T> 记录下 Spring Data JPA 多条件动态连表查询操作，以及其中的踩坑和优化。
想要直接看结论的，请看这篇 Spring Data JPA 动态多条件连表查询最佳实践。
基础操作 那么，让我们开始进入代码操作。【本文所有代码在此】
前置说明 相关依赖 Java 11 SpringBoot 2.4.2 build.gradle
plugins { id 'org.springframework.boot' version '2.4.2' id 'io.spring.dependency-management' version '1.0.11.RELEASE' id 'java' } dependencies { implementation 'org.springframework.boot:spring-boot-starter-data-jpa' compileOnly 'org.projectlombok:lombok' runtimeOnly 'mysql:mysql-connector-java' annotationProcessor 'org."><meta property="og:type" content="article"><meta property="og:url" content="https://lexcao.io/zh/posts/spring-data-jpa-join-table/"><meta property="og:image" content="https://images.unsplash.com/photo-1510843572979-e4b9e790fdd7?auto=format&fit=crop&w=720&q=80"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-24T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-24T00:00:00+00:00"><meta property="og:site_name" content="The Coding Notes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1510843572979-e4b9e790fdd7?auto=format&fit=crop&w=720&q=80"><meta name=twitter:title content="Spring Data JPA 多条件连表查询 (2022 更新)"><meta name=twitter:description content="痛点 项目中使用 Spring Data JPA 作为 ORM 框架的时候，实体映射非常方便。Spring Data Repository 的顶层抽象完全解决单实体的查询，面对单实体的复杂查询，也能使用 JpaSpecificationExecutor<T> 构造 Specification<T> 轻松应对。
而对于后台管理报表查询需求来说，需要进行连表多条件动态查询的时候，就显得无从下手。因为它并不像 MyBatis 一样能够在 XML 文件中写出动态 SQL 语句。
尽管可以使用 EntityManager 动态拼接原生 SQL 语句，但是该方法返回值为 ResultSet ，也就是说查出来的实体映射关系需要手动映射（😢这样不太优雅，已经定义出实体，还需要自己去映射）。
所以，本文的目的是，在现有实体关系的基础上，结合 Specification<T> 记录下 Spring Data JPA 多条件动态连表查询操作，以及其中的踩坑和优化。
想要直接看结论的，请看这篇 Spring Data JPA 动态多条件连表查询最佳实践。
基础操作 那么，让我们开始进入代码操作。【本文所有代码在此】
前置说明 相关依赖 Java 11 SpringBoot 2.4.2 build.gradle
plugins { id 'org.springframework.boot' version '2.4.2' id 'io.spring.dependency-management' version '1.0.11.RELEASE' id 'java' } dependencies { implementation 'org.springframework.boot:spring-boot-starter-data-jpa' compileOnly 'org.projectlombok:lombok' runtimeOnly 'mysql:mysql-connector-java' annotationProcessor 'org."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"Spring Data JPA 多条件连表查询 (2022 更新)","item":"https://lexcao.io/zh/posts/spring-data-jpa-join-table/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Data JPA 多条件连表查询 (2022 更新)","name":"Spring Data JPA 多条件连表查询 (2022 更新)","description":"痛点 项目中使用 Spring Data JPA 作为 ORM 框架的时候，实体映射非常方便。Spring Data Repository 的顶层抽象完全解决单实体的查询，面对单实体的复杂查询，也能使用 JpaSpecificationExecutor\u0026lt;T\u0026gt; 构造 Specification\u0026lt;T\u0026gt; 轻松应对。\n而对于后台管理报表查询需求来说，需要进行连表多条件动态查询的时候，就显得无从下手。因为它并不像 MyBatis 一样能够在 XML 文件中写出动态 SQL 语句。\n尽管可以使用 EntityManager 动态拼接原生 SQL 语句，但是该方法返回值为 ResultSet ，也就是说查出来的实体映射关系需要手动映射（😢这样不太优雅，已经定义出实体，还需要自己去映射）。\n所以，本文的目的是，在现有实体关系的基础上，结合 Specification\u0026lt;T\u0026gt; 记录下 Spring Data JPA 多条件动态连表查询操作，以及其中的踩坑和优化。\n想要直接看结论的，请看这篇 Spring Data JPA 动态多条件连表查询最佳实践。\n基础操作 那么，让我们开始进入代码操作。【本文所有代码在此】\n前置说明 相关依赖 Java 11 SpringBoot 2.4.2 build.gradle\nplugins { id \u0026#39;org.springframework.boot\u0026#39; version \u0026#39;2.4.2\u0026#39; id \u0026#39;io.spring.dependency-management\u0026#39; version \u0026#39;1.0.11.RELEASE\u0026#39; id \u0026#39;java\u0026#39; } dependencies { implementation \u0026#39;org.springframework.boot:spring-boot-starter-data-jpa\u0026#39; compileOnly \u0026#39;org.projectlombok:lombok\u0026#39; runtimeOnly \u0026#39;mysql:mysql-connector-java\u0026#39; annotationProcessor \u0026#39;org.","keywords":["Java","Kotlin","Spring","JPA"],"articleBody":"痛点 项目中使用 Spring Data JPA 作为 ORM 框架的时候，实体映射非常方便。Spring Data Repository 的顶层抽象完全解决单实体的查询，面对单实体的复杂查询，也能使用 JpaSpecificationExecutor 构造 Specification 轻松应对。\n而对于后台管理报表查询需求来说，需要进行连表多条件动态查询的时候，就显得无从下手。因为它并不像 MyBatis 一样能够在 XML 文件中写出动态 SQL 语句。\n尽管可以使用 EntityManager 动态拼接原生 SQL 语句，但是该方法返回值为 ResultSet ，也就是说查出来的实体映射关系需要手动映射（😢这样不太优雅，已经定义出实体，还需要自己去映射）。\n所以，本文的目的是，在现有实体关系的基础上，结合 Specification 记录下 Spring Data JPA 多条件动态连表查询操作，以及其中的踩坑和优化。\n想要直接看结论的，请看这篇 Spring Data JPA 动态多条件连表查询最佳实践。\n基础操作 那么，让我们开始进入代码操作。【本文所有代码在此】\n前置说明 相关依赖 Java 11 SpringBoot 2.4.2 build.gradle\nplugins { id 'org.springframework.boot' version '2.4.2' id 'io.spring.dependency-management' version '1.0.11.RELEASE' id 'java' } dependencies { implementation 'org.springframework.boot:spring-boot-starter-data-jpa' compileOnly 'org.projectlombok:lombok' runtimeOnly 'mysql:mysql-connector-java' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test' testRuntimeOnly 'com.h2database:h2' } maven.xml\n\u003cbuild\u003e \u003cplugins\u003e \u003cplugin\u003e \u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e \u003cartifactId\u003espring-boot-maven-plugin\u003c/artifactId\u003e \u003cconfiguration\u003e \u003cexcludes\u003e \u003cexclude\u003e \u003cgroupId\u003eorg.projectlombok\u003c/groupId\u003e \u003cartifactId\u003elombok\u003c/artifactId\u003e \u003c/exclude\u003e \u003c/excludes\u003e \u003c/configuration\u003e \u003c/plugin\u003e \u003c/plugins\u003e \u003c/build\u003e \u003cdependencies\u003e \u003cdependency\u003e \u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e \u003cartifactId\u003espring-boot-starter-data-jpa\u003c/artifactId\u003e \u003c/dependency\u003e \u003cdependency\u003e \u003cgroupId\u003ecom.h2database\u003c/groupId\u003e \u003cartifactId\u003eh2\u003c/artifactId\u003e \u003cscope\u003eruntime\u003c/scope\u003e \u003c/dependency\u003e \u003cdependency\u003e \u003cgroupId\u003eorg.projectlombok\u003c/groupId\u003e \u003cartifactId\u003elombok\u003c/artifactId\u003e \u003coptional\u003etrue\u003c/optional\u003e \u003c/dependency\u003e \u003cdependency\u003e \u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e \u003cartifactId\u003espring-boot-starter-test\u003c/artifactId\u003e \u003cscope\u003etest\u003c/scope\u003e \u003c/dependency\u003e \u003c/dependencies\u003e 模拟场景 三个实体：作者、书、书评。其中，作者与书是一对多的关系，书与书评是一对一的关系（当然书评与读者的评价是一对多的关系，这里省去，仅用一对一来进行演示即可）。\n假设有这样的后台查询条件：作者名称、书的发布时间、书评的评分。（这里每个实体取一个字段进行连表查询演示，其他字段同理）。返回书籍列表以及相关表字段。\n实体关系 表结构 CREATE TABLE `author` ( `id` VARCHAR(255) PRIMARY KEY, `name` VARCHAR(255) ); CREATE TABLE `book` ( `id` VARCHAR(255) PRIMARY KEY, `publish_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP, `author_id` VARCHAR(255), `review_id` VARCHAR(255) ); CREATE TABLE `review` ( `id` VARCHAR(255) PRIMARY KEY, `score` INT ); -- 数据初始化 INSERT INTO `author` (`id`, `name`) VALUES ('A_1', 'Author_1'), ('A_2', 'Author_2'), ('A_3', 'Author_3'), ('A_4', 'Author_4'), ('A_5', 'Author_5'); INSERT INTO `review` (`id`, `score`) VALUES ('R_1', 20), ('R_2', 30), ('R_3', 40), ('R_4', 50), ('R_5', 60), ('R_6', 70), ('R_7', 80), ('R_8', 90); INSERT INTO `book` (`id`, `author_id`, `review_id`) VALUES ('B_1', 'A_1', 'R_1'), ('B_2', 'A_2', 'R_2'), ('B_3', 'A_3', 'R_3'), ('B_4', 'A_4', 'R_4'), ('B_5', 'A_5', 'R_5'), ('B_6', 'A_2', 'R_6'), ('B_7', 'A_2', 'R_7'), ('B_8', 'A_3', 'R_8'); JPA 实体关系 使用 Java persistence API 构建如下实体关系，其他业务字段省略。\n@Data @Table @Entity public class Author { @Id private String id; private String name; } @Data @Table @Entity public class Book { @Id private String id; @Column(name = \"publish_time\") private LocalDateTime publishTime; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \"author_id\", foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT)) private Author author; @OneToOne(fetch = FetchType.LAZY) @JoinColumn(name = \"review_id\", foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT)) private Review review; } @Data @Table @Entity public class Review { @Id private String id; } 相关解释：\n@Data Lombok 注解，自动生成 getter、setter、hashcode、equals @Table @Entity @Id @Column @JoinColumn 均为 persistence API @ManyToOne 实体映射关系 多对一 @OneToOne 实体映射关系 一对一 在实际业务中，连表的时候不一定是查询多个实体的全部字段，为了不影响原有实体关系的正常映射，这里单独声明一个类 BookJoin 来映射查询条件返回。优雅的实现 Spring Data JPA 连表操作，这样做的好处是：\n只有 SELECT 查询出来的字段，才需要在实体里面声明出来 JOIN ON 后面的条件，需要在实体里面声明出来 再根据 Specification 中的 query.join 来进行 JOIN 以下是连表实体 BookJoin.java 文件\n@Data @Entity @Table(name = \"book\") public class BookJoin { @Id private String id; @Column(name = \"publish_time\") private LocalDateTime publishTime; @ManyToOne @JoinColumn(name = \"author_id\", foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT)) private Author author; @OneToOne @JoinColumn(name = \"review_id\", foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT)) private Review review; @Data @Entity @Table(name = \"author\") public static class Author { @Id private String id; private String name; } @Data @Entity @Table(name = \"review\") public static class Review { @Id private String id; private Integer score; } } 构建测试环境 为了演示多条件查询结果，这里使用 JUnit 来进行单元测试\nSpringBoot x JUnit 单元测试更详细的内容，请看另一篇博客\n/** * given: * empty query * then: * paged data */ @Test void multiQuery() { var spec = BookJoinSpec.multiQuery(emptyQuery()); var page = PageRequest.of(0, 5); queryBySpecMethod(spec, page); } private Page\u003cBookJoin\u003e queryBySpecMethod(Specification\u003cBookJoin\u003e spec, PageRequest pageRequest) { var books = repo.findAll(spec, pageRequest); assertThat(books.getNumberOfElements()).isGreaterThan(0); books.getContent().forEach(it -\u003e { assertThat(it).isNotNull(); // 访问结果集的属性，验证是否懒加载 assertThat(it.getAuthor().getName()).isNotNull(); assertThat(it.getReview().getScore()).isNotNull(); } ); return books; } 连表操作 如何进行声明式连表查询，这里讲演示各种写法的不同， 以及各个参数所起的作用，最后会给出一个最终版本作为最佳实践参考。\n01 版本 static Specification\u003cBookJoin\u003e multiQuery_01(BookJoinQuery param) { return (root, query, cb) -\u003e { var predicates = new LinkedList\u003cPredicate\u003e(); root.join(\"author\"); root.join(\"review\"); // ... }; } 通过以上的单元测试，打印出的 SQL 如下\nHibernate: SELECT `bookjoin0_`.`id` AS `id1_1_`, `bookjoin0_`.`author_id` AS `author_i3_1_`, `bookjoin0_`.`publish_time` AS `publish_2_1_`, `bookjoin0_`.`review_id` AS `review_i4_1_` FROM `book` `bookjoin0_` INNER JOIN `author` `bookjoin_a1_` ON `bookjoin0_`.`author_id` = `bookjoin_a1_`.`id` INNER JOIN `review` `bookjoin_r2_` ON `bookjoin0_`.`review_id` = `bookjoin_r2_`.`id` WHERE 1 = 1 LIMIT ? OFFSET ? Hibernate: SELECT `bookjoin_a0_`.`id` AS `id1_0_0_`, `bookjoin_a0_`.`name` AS `name2_0_0_` FROM `author` `bookjoin_a0_` WHERE `bookjoin_a0_`.`id` = ? Hibernate: SELECT `bookjoin_r0_`.`id` AS `id1_2_0_`, `bookjoin_r0_`.`score` AS `score2_2_0_` FROM `review` `bookjoin_r0_` WHERE `bookjoin_r0_`.`id` = ? Hibernate: SELECT `bookjoin_r0_`.`id` AS `id1_2_0_`, `bookjoin_r0_`.`score` AS `score2_2_0_` FROM `review` `bookjoin_r0_` WHERE `bookjoin_r0_`.`id` = ? Hibernate: SELECT `bookjoin_a0_`.`id` AS `id1_0_0_`, `bookjoin_a0_`.`name` AS `name2_0_0_` FROM `author` `bookjoin_a0_` WHERE `bookjoin_a0_`.`id` = ? Hibernate: SELECT `bookjoin_r0_`.`id` AS `id1_2_0_`, `bookjoin_r0_`.`score` AS `score2_2_0_` FROM `review` `bookjoin_r0_` WHERE `bookjoin_r0_`.`id` = ? 可以看到：\n数据总共查出来 3 条，结果执行的 SQL 语句有 7 条 分别是：1 条连表查询，3 条 author 表的单查询，3 条 review 表的单查询 02 版本 - 使用 fetch 优化 使用 fetch 替代 join\njoin 仅连表查询，返回的主实体的所有属性，可以理解为 SELECT book.* fetch 连表查询 + 快加载，返回连表所有实体的属性，可以理解为 SELECT * static Specification\u003cBookJoin\u003e multiQuery_02(BookJoinQuery param) { return (root, query, cb) -\u003e { // ... root.fetch(\"author\"); root.fetch(\"review\"); // ... }; } 通过以上的单元测试，打印出的 SQL 如下\nHibernate: SELECT `bookjoin0_`.`id` AS `id1_1_0_`, `bookjoin_a1_`.`id` AS `id1_0_1_`, `bookjoin_r2_`.`id` AS `id1_2_2_`, `bookjoin0_`.`author_id` AS `author_i3_1_0_`, `bookjoin0_`.`publish_time` AS `publish_2_1_0_`, `bookjoin0_`.`review_id` AS `review_i4_1_0_`, `bookjoin_a1_`.`name` AS `name2_0_1_`, `bookjoin_r2_`.`score` AS `score2_2_2_` FROM `book` `bookjoin0_` INNER JOIN `author` `bookjoin_a1_` ON `bookjoin0_`.`author_id` = `bookjoin_a1_`.`id` INNER JOIN `review` `bookjoin_r2_` ON `bookjoin0_`.`review_id` = `bookjoin_r2_`.`id` WHERE 1 = 1 LIMIT ? OFFSET ? 可以看到：\n执行的 SQL 只有 1 条 SELECT 中的字段包括连表的字段 踩坑 - 分页问题 创建一个新的单元测试，直接使用 fetch 分页报错\n@Test void multiQuery_02() { var spec = BookJoinSpec.multiQuery_02(emptyQuery()); var page = PageRequest.of(0, 5); assertThatThrownBy(() -\u003e queryBySpecMethod(spec, page)) .hasCauseInstanceOf(QueryException.class); } 当使用 fetch 再进行分页的时候，会报以下错误\nCaused by: org.hibernate.QueryException: query specified join fetching, but the owner of the fetched association was not present in the select list. 原因分析：\n实际报错出现在 count 语句，错误信息表示该 count 语句返回值没有找到具体的映射属性 解决方法：\n针对分页的 count 查询语句单独做处理，代码如下 static Specification\u003cBookJoin\u003e multiQuery_02_fix(BookJoinQuery param) { return (root, query, cb) -\u003e { // ... if (Long.class.equals(query.getResultType()) || long.class.equals(query.getResultType())) { root.join(\"author\"); root.join(\"review\"); } else { root.fetch(\"author\"); root.fetch(\"review\"); } // ... }; } 注意 可能疑问「上面 BookJoin 实体里面声明关系不是 fetch = FetchType.LAZY ，没有指明是懒加载，为什么连表查询的时候还是没有加载出来」。\n原因是 JPA 里面 join 机制处理，原理大致是这样的：\n根据 join 和 fetch 生成不同的 JpaQL 语句，差别在于 join 与 join fetch -- fetch 生成的 JpaQL 语句 select generatedAlias0 from BookJoin as generatedAlias0 inner join fetch generatedAlias0.author as generatedAlias1 inner join fetch generatedAlias0.review as generatedAlias2 where 1=1 -- join 生成的 JpaQL 语句 select generatedAlias0 from BookJoin as generatedAlias0 inner join generatedAlias0.author as generatedAlias1 inner join generatedAlias0.review as generatedAlias2 where 1=1 JpaQL 语句根据 join fetch 转换为 HQL 再转换为最终的 SQL 语句，通过 QueryTranslatorImpl 类，在 doCompile 方法看到完整转换过程，部分代码如下 // QueryTranslatorImpl // doCompile -\u003e analyze -\u003e HqlSqlBaseWalker.statement -\u003e selectStatement // selectClause -\u003e fromClause -\u003e fromElementList -\u003e fromElement -\u003e joinElement // HqlSqlWalker.java createFromJoinElement #367 // DotNode 此处设置 fetch DotNode dot = (DotNode) path; JoinType hibernateJoinType = JoinProcessor.toHibernateJoinType( joinType ); dot.setJoinType( hibernateJoinType ); // Tell the dot node about the join type. dot.setFetch( fetch ); // Generate an explicit join for the root dot node. The implied joins will be collected and passed up // to the root dot node. dot.resolve( true, false, alias == null ? null : alias.getText() ); // 解析阶段 // selectStatement -\u003e query -\u003e processQuery // 上面的报错在此处 SelectClause.java #212 if ( !fromElementsForLoad.contains( origin ) \u0026\u0026 !fromElementsForLoad.contains( fromElement.getFetchOrigin() ) ) throw new QueryException( \"query specified join fetching, but the owner \" + \"of the fetched association was not present in the select list \" + \"[\" + fromElement.getDisplayText() + \"]\" ); } 03 版本 - 加上 WHERE 条件筛选 创建一个新的单元测试，筛选一下 Join 条件\n@Test void multiQuery_03() { var query = BookJoinQuery.builder() .authorName(\"Author_2\") .build(); var spec = BookJoinSpec.multiQuery_03(query); var page = PageRequest.of(0, 5); var result = queryBySpecMethod(spec, page); var givenAuthor = result.getContent().get(0).getAuthor(); assertThat(givenAuthor.getName()).isEqualTo(\"Author_2\"); } 具体的连表查询条件如下\nstatic Specification\u003cBookJoin\u003e multiQuery_03(BookJoinQuery param) { return (root, query, cb) -\u003e { var predicates = new LinkedList\u003cPredicate\u003e(); if (Long.class.equals(query.getResultType()) || long.class.equals(query.getResultType())) { root.join(\"author\"); root.join(\"review\"); } else { root.fetch(\"author\"); root.fetch(\"review\"); } if (null != param.getBookPublishTime()) { predicates.add(cb.equal(root.get(\"publishTime\"), param.getBookPublishTime())); } if (null != param.getAuthorName()) { predicates.add(cb.equal(root.get(\"author\").get(\"name\"), param.getAuthorName())); } if (null != param.getReviewScore()) { predicates.add(cb.equal(root.get(\"review\").get(\"score\"), param.getReviewScore())); } query.where(predicates.toArray(new Predicate[0])); return query.getRestriction(); }; } 生成的查询语句如下，可以看到查询条件是拼接在 WHERE 部分\nselect bookjoin0_.id as id1_1_0_, bookjoin_a1_.id as id1_0_1_, bookjoin_r2_.id as id1_2_2_, bookjoin0_.author_id as author_i3_1_0_, bookjoin0_.publish_time as publish_2_1_0_, bookjoin0_.review_id as review_i4_1_0_, bookjoin_a1_.name as name2_0_1_, bookjoin_r2_.score as score2_2_2_ from book bookjoin0_ inner join author bookjoin_a1_ on bookjoin0_.author_id = bookjoin_a1_.id inner join review bookjoin_r2_ on bookjoin0_.review_id = bookjoin_r2_.id where bookjoin_a1_.name = ? limit ? 如果我想要针对 join 的表进行 on 条件查询，应该怎么做呢？ 下面来看下 04 版本。\n04 版本 - 加上 JOIN ON 条件筛选 创建一个新的单元测试\n@Test void multiQuery_04() { var query = BookJoinQuery.builder() .authorName(\"Author_2\") .reviewScore(70) .build(); var spec = BookJoinSpec.multiQuery_04(query); var page = PageRequest.of(0, 5); var bookJoin = queryBySpecMethod(spec, page).getContent().get(0); assertThat(bookJoin.getAuthor().getName()).isEqualTo(\"Author_2\"); assertThat(bookJoin.getReview().getScore()).isEqualTo(70); } 首先直接对 join 条件进行 on 查询\nstatic Specification\u003cBookJoin\u003e multiQuery_04(BookJoinQuery param) { return (root, query, cb) -\u003e { if (null != param.getBookPublishTime()) { query.where(cb.equal(root.get(\"publishTime\"), param.getBookPublishTime())); } if (null != param.getAuthorName()) { Join\u003cObject, Object\u003e author = root.join(\"author\"); author.on(cb.equal(author.get(\"name\"), param.getAuthorName())); } if (null != param.getReviewScore()) { Join\u003cObject, Object\u003e review = root.join(\"review\"); review.on(cb.equal(review.get(\"score\"), param.getReviewScore())); } return query.getRestriction(); }; } 此时生成的 SQL 语句如下，能够成功拼接 JOIN ON 条件但是出现 N + 1 问题，\nselect bookjoin0_.id as id1_1_, bookjoin0_.author_id as author_i3_1_, bookjoin0_.publish_time as publish_2_1_, bookjoin0_.review_id as review_i4_1_ from book bookjoin0_ inner join author bookjoin_a1_ on bookjoin0_.author_id = bookjoin_a1_.id and (bookjoin_a1_.name = ?) inner join review bookjoin_r2_ on bookjoin0_.review_id = bookjoin_r2_.id and (bookjoin_r2_.score = ?) limit ? select bookjoin_a0_.id as id1_0_0_, bookjoin_a0_.name as name2_0_0_ from author bookjoin_a0_ where bookjoin_a0_.id = ? select bookjoin_r0_.id as id1_2_0_, bookjoin_r0_.score as score2_2_0_ from review bookjoin_r0_ where bookjoin_r0_.id = ? 此时如果我们改用 fetch 的话，又不能进行 on 条件筛选，该怎么处理呢？\n这里的解决方案是引入一个新的注解 @EntityGraph，修改我们的查询方法\n主动声明查询方法返回的 Entity 明确需要进行 Fetch 的属性有哪些 @Override @EntityGraph(attributePaths = { \"author\", \"review\" }) Page\u003cBookJoin\u003e findAll(Specification\u003cBookJoin\u003e spec, Pageable pageable); 再看一下生成的语句，很好，自动帮忙 fetch 出来了，并且也解决了 02 版本的分页查询问题\nselect bookjoin0_.id as id1_1_0_, bookjoin_a1_.id as id1_0_1_, bookjoin_r2_.id as id1_2_2_, bookjoin0_.author_id as author_i3_1_0_, bookjoin0_.publish_time as publish_2_1_0_, bookjoin0_.review_id as review_i4_1_0_, bookjoin_a1_.name as name2_0_1_, bookjoin_r2_.score as score2_2_2_ from book bookjoin0_ inner join author bookjoin_a1_ on bookjoin0_.author_id = bookjoin_a1_.id and (bookjoin_a1_.name = ?) inner join review bookjoin_r2_ on bookjoin0_.review_id = bookjoin_r2_.id and (bookjoin_r2_.score = ?) limit ? 注意 上面使用的示例是针对【强一对一关系】所以使用默认的连接类型 INNER JOIN\n当然也可以使用左外连接（右外连接不支持）\nroot.join(\"author\", JoinType.LEFT); root.fetch(\"author\", JoinType.LEFT); 扩展阅读 Advanced Spring Data JPA - Specifications and Querydsl REST Query Language with Spring Data JPA Specifications Spring Data JPA Specification DSL for Kotlin 🔗 链接 Github source Spring Data JPA使用Specification 👀总结 使用 SpringJPA 来写动态多条件连表查询，通过代码来控制 SQL 语句，需要对 JPA 以及 Hibernate 相关 API 相对熟练才可以写出优质的 SQL 语句生成。 和 MyBatis 可以直接拼接 SQL 的相比，各有应用场景。 整体来说用代码来写 JPA 的动态查询，对于习惯 SQL 语句的人来说，还是感觉隔了一层。 对于这样的分页连表查询，个人感觉还是 MyBatis 舒服一点，简单。 ","wordCount":"1549","inLanguage":"zh","datePublished":"2022-09-24T00:00:00Z","dateModified":"2022-09-24T00:00:00Z","author":{"@type":"Person","name":"Lex Cao"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lexcao.io/zh/posts/spring-data-jpa-join-table/"},"publisher":{"@type":"Organization","name":"The Coding Notes","logo":{"@type":"ImageObject","url":"https://lexcao.io/favicon.ico"}}}</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-KJ277ZJ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://lexcao.io/zh/ accesskey=h title="代码笔记 (Alt + H)">代码笔记</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://lexcao.io/ title=English aria-label=English>English</a></li></ul></span></div><ul id=menu><li><a href=https://lexcao.io/zh/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://lexcao.io/zh/archives/ title=归档><span>归档</span></a></li><li><a href=https://lexcao.io/zh/tags/ title=标签><span>标签</span></a></li><li><a href=https://lexcao.io/zh/projects/ title=项目><span>项目</span></a></li><li><a href=https://lexcao.io/zh/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lexcao.io/zh/>主页</a></div><h1 class=post-title>Spring Data JPA 多条件连表查询 (2022 更新)</h1><div class=post-meta>2022 September 24&nbsp;·&nbsp;8 分钟&nbsp;·&nbsp;Lex Cao</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>目录</div></summary><div class=inner><ul><li><a href=#%e7%97%9b%e7%82%b9 aria-label=痛点>痛点</a></li><li><a href=#%e5%9f%ba%e7%a1%80%e6%93%8d%e4%bd%9c aria-label=基础操作>基础操作</a><ul><li><a href=#%e5%89%8d%e7%bd%ae%e8%af%b4%e6%98%8e aria-label=前置说明>前置说明</a><ul><li><a href=#%e7%9b%b8%e5%85%b3%e4%be%9d%e8%b5%96 aria-label=相关依赖>相关依赖</a></li><li><a href=#%e6%a8%a1%e6%8b%9f%e5%9c%ba%e6%99%af aria-label=模拟场景>模拟场景</a></li></ul></li><li><a href=#%e5%ae%9e%e4%bd%93%e5%85%b3%e7%b3%bb aria-label=实体关系>实体关系</a><ul><li><a href=#%e8%a1%a8%e7%bb%93%e6%9e%84 aria-label=表结构>表结构</a></li><li><a href=#jpa-%e5%ae%9e%e4%bd%93%e5%85%b3%e7%b3%bb aria-label="JPA 实体关系">JPA 实体关系</a></li></ul></li><li><a href=#%e6%9e%84%e5%bb%ba%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83 aria-label=构建测试环境>构建测试环境</a></li></ul></li><li><a href=#%e8%bf%9e%e8%a1%a8%e6%93%8d%e4%bd%9c aria-label=连表操作>连表操作</a><ul><li><a href=#01-%e7%89%88%e6%9c%ac aria-label="01 版本">01 版本</a></li><li><a href=#02-%e7%89%88%e6%9c%ac---%e4%bd%bf%e7%94%a8-fetch-%e4%bc%98%e5%8c%96 aria-label="02 版本 - 使用 fetch 优化">02 版本 - 使用 fetch 优化</a><ul><li><a href=#%e8%b8%a9%e5%9d%91---%e5%88%86%e9%a1%b5%e9%97%ae%e9%a2%98 aria-label="踩坑 - 分页问题">踩坑 - 分页问题</a></li><li><a href=#%e6%b3%a8%e6%84%8f aria-label=注意>注意</a></li></ul></li><li><a href=#03-%e7%89%88%e6%9c%ac---%e5%8a%a0%e4%b8%8a-where-%e6%9d%a1%e4%bb%b6%e7%ad%9b%e9%80%89 aria-label="03 版本 - 加上 WHERE 条件筛选">03 版本 - 加上 WHERE 条件筛选</a></li><li><a href=#04-%e7%89%88%e6%9c%ac---%e5%8a%a0%e4%b8%8a-join-on-%e6%9d%a1%e4%bb%b6%e7%ad%9b%e9%80%89 aria-label="04 版本 - 加上 JOIN ON 条件筛选">04 版本 - 加上 JOIN ON 条件筛选</a></li><li><a href=#%e6%b3%a8%e6%84%8f-1 aria-label=注意>注意</a></li></ul></li><li><a href=#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb aria-label=扩展阅读>扩展阅读</a></li><li><a href=#-%e9%93%be%e6%8e%a5 aria-label="🔗 链接">🔗 链接</a></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=👀总结>👀总结</a></li></ul></div></details></div><div class=post-content><h1 id=痛点>痛点<a hidden class=anchor aria-hidden=true href=#痛点>#</a></h1><p>项目中使用 Spring Data JPA 作为 ORM 框架的时候，实体映射非常方便。Spring Data Repository 的顶层抽象完全解决单实体的查询，面对单实体的复杂查询，也能使用 <code>JpaSpecificationExecutor&lt;T></code> 构造 <code>Specification&lt;T></code> 轻松应对。</p><p>而对于后台管理报表查询需求来说，需要进行连表多条件动态查询的时候，就显得无从下手。因为它并不像 MyBatis 一样能够在 XML 文件中写出动态 SQL 语句。</p><p>尽管可以使用 <code>EntityManager</code> 动态拼接原生 SQL 语句，但是该方法返回值为 <code>ResultSet</code> ，也就是说查出来的实体映射关系需要手动映射（😢这样不太优雅，已经定义出实体，还需要自己去映射）。</p><p>所以，本文的目的是，在现有实体关系的基础上，结合 <code>Specification&lt;T></code> 记录下 Spring Data JPA 多条件动态连表查询操作，以及其中的踩坑和优化。</p><p>想要直接看结论的，请看这篇 <a href=/zh/posts/spring-data-jpa-join-table-best-practice>Spring Data JPA 动态多条件连表查询最佳实践</a>。</p><h1 id=基础操作>基础操作<a hidden class=anchor aria-hidden=true href=#基础操作>#</a></h1><p>那么，让我们开始进入代码操作。【<a href=https://github.com/lexcao/spring-data-jpa-join-table>本文所有代码在此</a>】</p><h2 id=前置说明>前置说明<a hidden class=anchor aria-hidden=true href=#前置说明>#</a></h2><h3 id=相关依赖>相关依赖<a hidden class=anchor aria-hidden=true href=#相关依赖>#</a></h3><ul><li>Java 11</li><li>SpringBoot 2.4.2</li></ul><p>build.gradle</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>plugins <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    id <span style=color:#e6db74>&#39;org.springframework.boot&#39;</span> version <span style=color:#e6db74>&#39;2.4.2&#39;</span>
</span></span><span style=display:flex><span>    id <span style=color:#e6db74>&#39;io.spring.dependency-management&#39;</span> version <span style=color:#e6db74>&#39;1.0.11.RELEASE&#39;</span>
</span></span><span style=display:flex><span>    id <span style=color:#e6db74>&#39;java&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-data-jpa&#39;</span>
</span></span><span style=display:flex><span>    compileOnly <span style=color:#e6db74>&#39;org.projectlombok:lombok&#39;</span>
</span></span><span style=display:flex><span>    runtimeOnly <span style=color:#e6db74>&#39;mysql:mysql-connector-java&#39;</span>
</span></span><span style=display:flex><span>    annotationProcessor <span style=color:#e6db74>&#39;org.projectlombok:lombok&#39;</span>
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>
</span></span><span style=display:flex><span>    testRuntimeOnly <span style=color:#e6db74>&#39;com.h2database:h2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>maven.xml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>&lt;</span>build<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>plugins<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>plugin<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span>groupId<span style=color:#f92672>&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/</span>groupId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span>artifactId<span style=color:#f92672>&gt;</span>spring<span style=color:#f92672>-</span>boot<span style=color:#f92672>-</span>maven<span style=color:#f92672>-</span>plugin<span style=color:#f92672>&lt;/</span>artifactId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span>configuration<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span>excludes<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;</span>exclude<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>&lt;</span>groupId<span style=color:#f92672>&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/</span>groupId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>&lt;</span>artifactId<span style=color:#f92672>&gt;</span>lombok<span style=color:#f92672>&lt;/</span>artifactId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/</span>exclude<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;/</span>excludes<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/</span>configuration<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/</span>plugin<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/</span>plugins<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/</span>build<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>dependencies<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>groupId<span style=color:#f92672>&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/</span>groupId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>artifactId<span style=color:#f92672>&gt;</span>spring<span style=color:#f92672>-</span>boot<span style=color:#f92672>-</span>starter<span style=color:#f92672>-</span><span style=color:#66d9ef>data</span><span style=color:#f92672>-</span>jpa<span style=color:#f92672>&lt;/</span>artifactId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>groupId<span style=color:#f92672>&gt;</span>com.h2database<span style=color:#f92672>&lt;/</span>groupId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>artifactId<span style=color:#f92672>&gt;</span>h2<span style=color:#f92672>&lt;/</span>artifactId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>scope</span><span style=color:#f92672>&gt;</span>runtime<span style=color:#f92672>&lt;/</span><span style=color:#66d9ef>scope</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>groupId<span style=color:#f92672>&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/</span>groupId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>artifactId<span style=color:#f92672>&gt;</span>lombok<span style=color:#f92672>&lt;/</span>artifactId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>optional<span style=color:#f92672>&gt;</span><span style=color:#66d9ef>true</span><span style=color:#f92672>&lt;/</span>optional<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>groupId<span style=color:#f92672>&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/</span>groupId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span>artifactId<span style=color:#f92672>&gt;</span>spring<span style=color:#f92672>-</span>boot<span style=color:#f92672>-</span>starter<span style=color:#f92672>-</span>test<span style=color:#f92672>&lt;/</span>artifactId<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>scope</span><span style=color:#f92672>&gt;</span>test<span style=color:#f92672>&lt;/</span><span style=color:#66d9ef>scope</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/</span>dependency<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/</span>dependencies<span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><h3 id=模拟场景>模拟场景<a hidden class=anchor aria-hidden=true href=#模拟场景>#</a></h3><p>三个实体：作者、书、书评。其中，作者与书是一对多的关系，书与书评是一对一的关系（当然书评与读者的评价是一对多的关系，这里省去，仅用一对一来进行演示即可）。</p><p>假设有这样的后台查询条件：作者名称、书的发布时间、书评的评分。（这里每个实体取一个字段进行连表查询演示，其他字段同理）。返回书籍列表以及相关表字段。</p><h2 id=实体关系>实体关系<a hidden class=anchor aria-hidden=true href=#实体关系>#</a></h2><h3 id=表结构>表结构<a hidden class=anchor aria-hidden=true href=#表结构>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>author<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>book<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>publish_time<span style=color:#f92672>`</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CURRENT_TIMESTAMP</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>),
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>review_id<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>review<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>score<span style=color:#f92672>`</span> INT
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 数据初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>author<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;A_1&#39;</span>, <span style=color:#e6db74>&#39;Author_1&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;A_2&#39;</span>, <span style=color:#e6db74>&#39;Author_2&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;A_3&#39;</span>, <span style=color:#e6db74>&#39;Author_3&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;A_4&#39;</span>, <span style=color:#e6db74>&#39;Author_4&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;A_5&#39;</span>, <span style=color:#e6db74>&#39;Author_5&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>review<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>score<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;R_1&#39;</span>, <span style=color:#ae81ff>20</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;R_2&#39;</span>, <span style=color:#ae81ff>30</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;R_3&#39;</span>, <span style=color:#ae81ff>40</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;R_4&#39;</span>, <span style=color:#ae81ff>50</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;R_5&#39;</span>, <span style=color:#ae81ff>60</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;R_6&#39;</span>, <span style=color:#ae81ff>70</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;R_7&#39;</span>, <span style=color:#ae81ff>80</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;R_8&#39;</span>, <span style=color:#ae81ff>90</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>book<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>review_id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;B_1&#39;</span>, <span style=color:#e6db74>&#39;A_1&#39;</span>, <span style=color:#e6db74>&#39;R_1&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;B_2&#39;</span>, <span style=color:#e6db74>&#39;A_2&#39;</span>, <span style=color:#e6db74>&#39;R_2&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;B_3&#39;</span>, <span style=color:#e6db74>&#39;A_3&#39;</span>, <span style=color:#e6db74>&#39;R_3&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;B_4&#39;</span>, <span style=color:#e6db74>&#39;A_4&#39;</span>, <span style=color:#e6db74>&#39;R_4&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;B_5&#39;</span>, <span style=color:#e6db74>&#39;A_5&#39;</span>, <span style=color:#e6db74>&#39;R_5&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;B_6&#39;</span>, <span style=color:#e6db74>&#39;A_2&#39;</span>, <span style=color:#e6db74>&#39;R_6&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;B_7&#39;</span>, <span style=color:#e6db74>&#39;A_2&#39;</span>, <span style=color:#e6db74>&#39;R_7&#39;</span>),
</span></span><span style=display:flex><span>       (<span style=color:#e6db74>&#39;B_8&#39;</span>, <span style=color:#e6db74>&#39;A_3&#39;</span>, <span style=color:#e6db74>&#39;R_8&#39;</span>);
</span></span></code></pre></div><h3 id=jpa-实体关系>JPA 实体关系<a hidden class=anchor aria-hidden=true href=#jpa-实体关系>#</a></h3><p>使用 Java persistence API 构建如下实体关系，其他业务字段省略。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Author</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Book</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Column</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;publish_time&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime publishTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ManyToOne</span><span style=color:#f92672>(</span>fetch <span style=color:#f92672>=</span> FetchType<span style=color:#f92672>.</span><span style=color:#a6e22e>LAZY</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@JoinColumn</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;author_id&#34;</span><span style=color:#f92672>,</span> foreignKey <span style=color:#f92672>=</span> <span style=color:#a6e22e>@ForeignKey</span><span style=color:#f92672>(</span>ConstraintMode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_CONSTRAINT</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Author author<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@OneToOne</span><span style=color:#f92672>(</span>fetch <span style=color:#f92672>=</span> FetchType<span style=color:#f92672>.</span><span style=color:#a6e22e>LAZY</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@JoinColumn</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;review_id&#34;</span><span style=color:#f92672>,</span> foreignKey <span style=color:#f92672>=</span> <span style=color:#a6e22e>@ForeignKey</span><span style=color:#f92672>(</span>ConstraintMode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_CONSTRAINT</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Review review<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Review</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>相关解释：</p><ul><li><code>@Data</code> Lombok 注解，自动生成 getter、setter、hashcode、equals</li><li><code>@Table</code> <code>@Entity</code> <code>@Id</code> <code>@Column</code> <code>@JoinColumn</code> 均为 persistence API</li><li><code>@ManyToOne</code> 实体映射关系 多对一</li><li><code>@OneToOne</code> 实体映射关系 一对一</li></ul><p>在实际业务中，连表的时候不一定是查询多个实体的全部字段，为了不影响原有实体关系的正常映射，这里单独声明一个类 <code>BookJoin</code> 来映射查询条件返回。优雅的实现 Spring Data JPA 连表操作，这样做的好处是：</p><ul><li>只有 SELECT 查询出来的字段，才需要在实体里面声明出来</li><li>JOIN ON 后面的条件，需要在实体里面声明出来</li><li>再根据 Specification 中的 query.join 来进行 JOIN</li></ul><p>以下是连表实体 <code>BookJoin.java</code> 文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;book&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BookJoin</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Column</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;publish_time&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime publishTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ManyToOne</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@JoinColumn</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;author_id&#34;</span><span style=color:#f92672>,</span> foreignKey <span style=color:#f92672>=</span> <span style=color:#a6e22e>@ForeignKey</span><span style=color:#f92672>(</span>ConstraintMode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_CONSTRAINT</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Author author<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@OneToOne</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@JoinColumn</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;review_id&#34;</span><span style=color:#f92672>,</span> foreignKey <span style=color:#f92672>=</span> <span style=color:#a6e22e>@ForeignKey</span><span style=color:#f92672>(</span>ConstraintMode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_CONSTRAINT</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Review review<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Table</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Author</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Table</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Review</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String id<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Integer score<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=构建测试环境>构建测试环境<a hidden class=anchor aria-hidden=true href=#构建测试环境>#</a></h2><p>为了演示多条件查询结果，这里使用 JUnit 来进行单元测试</p><blockquote><p>SpringBoot x JUnit 单元测试更详细的内容，请看另一篇博客</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  given:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *      empty query
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  then:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *      paged data
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>multiQuery</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var spec <span style=color:#f92672>=</span> BookJoinSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>multiQuery</span><span style=color:#f92672>(</span>emptyQuery<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    var page <span style=color:#f92672>=</span> PageRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 5<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    queryBySpecMethod<span style=color:#f92672>(</span>spec<span style=color:#f92672>,</span> page<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Page<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>queryBySpecMethod</span><span style=color:#f92672>(</span>Specification<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> spec<span style=color:#f92672>,</span> PageRequest pageRequest<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var books <span style=color:#f92672>=</span> repo<span style=color:#f92672>.</span><span style=color:#a6e22e>findAll</span><span style=color:#f92672>(</span>spec<span style=color:#f92672>,</span> pageRequest<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertThat<span style=color:#f92672>(</span>books<span style=color:#f92672>.</span><span style=color:#a6e22e>getNumberOfElements</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>isGreaterThan</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    books<span style=color:#f92672>.</span><span style=color:#a6e22e>getContent</span><span style=color:#f92672>().</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>it <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            assertThat<span style=color:#f92672>(</span>it<span style=color:#f92672>).</span><span style=color:#a6e22e>isNotNull</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>						<span style=color:#75715e>// 访问结果集的属性，验证是否懒加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            assertThat<span style=color:#f92672>(</span>it<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthor</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>isNotNull</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            assertThat<span style=color:#f92672>(</span>it<span style=color:#f92672>.</span><span style=color:#a6e22e>getReview</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getScore</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>isNotNull</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> books<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=连表操作>连表操作<a hidden class=anchor aria-hidden=true href=#连表操作>#</a></h1><p>如何进行声明式连表查询，这里讲演示各种写法的不同， 以及各个参数所起的作用，最后会给出一个最终版本作为最佳实践参考。</p><h2 id=01-版本>01 版本<a hidden class=anchor aria-hidden=true href=#01-版本>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> Specification<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>multiQuery_01</span><span style=color:#f92672>(</span>BookJoinQuery param<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>root<span style=color:#f92672>,</span> query<span style=color:#f92672>,</span> cb<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var predicates <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedList<span style=color:#f92672>&lt;</span>Predicate<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过以上的单元测试，打印出的 SQL 如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>Hibernate:
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_1_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>author_i3_1_<span style=color:#f92672>`</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>publish_time<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>publish_2_1_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>review_id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>review_i4_1_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>book<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> <span style=color:#f92672>`</span>author<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_a1_<span style=color:#f92672>`</span> <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>`</span>bookjoin_a1_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> <span style=color:#f92672>`</span>review<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_r2_<span style=color:#f92672>`</span> <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>review_id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>`</span>bookjoin_r2_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>OFFSET</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>Hibernate:
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_0_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>name2_0_0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>author<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>Hibernate:
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_2_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>score<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>score2_2_0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>review<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>Hibernate:
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_2_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>score<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>score2_2_0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>review<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>Hibernate:
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_0_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>name2_0_0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>author<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>bookjoin_a0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>Hibernate:
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_2_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>score<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>score2_2_0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>review<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>bookjoin_r0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span></code></pre></div><p>可以看到：</p><ul><li>数据总共查出来 3 条，结果执行的 SQL 语句有 7 条</li><li>分别是：1 条连表查询，3 条 <code>author</code> 表的单查询，3 条 <code>review</code> 表的单查询</li></ul><h2 id=02-版本---使用-fetch-优化>02 版本 - 使用 fetch 优化<a hidden class=anchor aria-hidden=true href=#02-版本---使用-fetch-优化>#</a></h2><p>使用 <code>fetch</code> 替代 <code>join</code></p><ul><li><code>join</code> 仅连表查询，返回的主实体的所有属性，可以理解为 <code>SELECT book.*</code></li><li><code>fetch</code> 连表查询 + 快加载，返回连表所有实体的属性，可以理解为 <code>SELECT *</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> Specification<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>multiQuery_02</span><span style=color:#f92672>(</span>BookJoinQuery param<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>root<span style=color:#f92672>,</span> query<span style=color:#f92672>,</span> cb<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	      <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        root<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        root<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过以上的单元测试，打印出的 SQL 如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>Hibernate:
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_1_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_a1_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_0_1_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_r2_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>id1_2_2_<span style=color:#f92672>`</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>author_i3_1_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>publish_time<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>publish_2_1_0_<span style=color:#f92672>`</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>review_id<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>review_i4_1_0_<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>bookjoin_a1_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>name2_0_1_<span style=color:#f92672>`</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>bookjoin_r2_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>score<span style=color:#f92672>`</span> <span style=color:#66d9ef>AS</span> <span style=color:#f92672>`</span>score2_2_2_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>book<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> <span style=color:#f92672>`</span>author<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_a1_<span style=color:#f92672>`</span> <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>`</span>bookjoin_a1_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> <span style=color:#f92672>`</span>review<span style=color:#f92672>`</span> <span style=color:#f92672>`</span>bookjoin_r2_<span style=color:#f92672>`</span> <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>bookjoin0_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>review_id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#f92672>`</span>bookjoin_r2_<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>OFFSET</span> <span style=color:#f92672>?</span>
</span></span></code></pre></div><p>可以看到：</p><ul><li>执行的 SQL 只有 1 条</li><li>SELECT 中的字段包括连表的字段</li></ul><h3 id=踩坑---分页问题>踩坑 - 分页问题<a hidden class=anchor aria-hidden=true href=#踩坑---分页问题>#</a></h3><p>创建一个新的单元测试，直接使用 <code>fetch</code> 分页报错</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>multiQuery_02</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var spec <span style=color:#f92672>=</span> BookJoinSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>multiQuery_02</span><span style=color:#f92672>(</span>emptyQuery<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    var page <span style=color:#f92672>=</span> PageRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 5<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    assertThatThrownBy<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> queryBySpecMethod<span style=color:#f92672>(</span>spec<span style=color:#f92672>,</span> page<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>.</span><span style=color:#a6e22e>hasCauseInstanceOf</span><span style=color:#f92672>(</span>QueryException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当使用 <code>fetch</code> 再进行分页的时候，会报以下错误</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Caused by<span style=color:#f92672>:</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>hibernate</span><span style=color:#f92672>.</span><span style=color:#a6e22e>QueryException</span><span style=color:#f92672>:</span> query specified join fetching<span style=color:#f92672>,</span> but the owner of the fetched association was not present in the select list<span style=color:#f92672>.</span>
</span></span></code></pre></div><p>原因分析：</p><ul><li>实际报错出现在 count 语句，错误信息表示该 count 语句返回值没有找到具体的映射属性</li></ul><p>解决方法：</p><ul><li>针对分页的 count 查询语句单独做处理，代码如下</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> Specification<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>multiQuery_02_fix</span><span style=color:#f92672>(</span>BookJoinQuery param<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>root<span style=color:#f92672>,</span> query<span style=color:#f92672>,</span> cb<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	      <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Long<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>query<span style=color:#f92672>.</span><span style=color:#a6e22e>getResultType</span><span style=color:#f92672>())</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>long</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>query<span style=color:#f92672>.</span><span style=color:#a6e22e>getResultType</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	          root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	          root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	          root<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	          root<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=注意>注意<a hidden class=anchor aria-hidden=true href=#注意>#</a></h3><p>可能疑问「上面 BookJoin 实体里面声明关系不是 <code>fetch = FetchType.LAZY</code> ，没有指明是懒加载，为什么连表查询的时候还是没有加载出来」。</p><p>原因是 JPA 里面 <code>join</code> 机制处理，原理大致是这样的：</p><ol><li>根据 <code>join</code> 和 <code>fetch</code> 生成不同的 <code>JpaQL</code> 语句，差别在于 <code>join</code> 与 <code>join fetch</code></li></ol><pre tabindex=0><code>-- fetch 生成的 JpaQL 语句
select generatedAlias0 from BookJoin as generatedAlias0 inner join fetch generatedAlias0.author as generatedAlias1 inner join fetch generatedAlias0.review as generatedAlias2 where 1=1

-- join 生成的 JpaQL 语句
select generatedAlias0 from BookJoin as generatedAlias0 inner join generatedAlias0.author as generatedAlias1 inner join generatedAlias0.review as generatedAlias2 where 1=1
</code></pre><ol start=2><li><code>JpaQL</code> 语句根据 <code>join fetch</code> 转换为 <code>HQL</code> 再转换为最终的 SQL 语句，通过 <code>QueryTranslatorImpl</code> 类，在 <code>doCompile</code> 方法看到完整转换过程，部分代码如下</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// QueryTranslatorImpl
</span></span></span><span style=display:flex><span><span style=color:#75715e>// doCompile -&gt; analyze -&gt; HqlSqlBaseWalker.statement -&gt; selectStatement
</span></span></span><span style=display:flex><span><span style=color:#75715e>// selectClause -&gt; fromClause -&gt; fromElementList -&gt; fromElement -&gt; joinElement
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// HqlSqlWalker.java createFromJoinElement  #367
</span></span></span><span style=display:flex><span><span style=color:#75715e>// DotNode 此处设置 fetch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>DotNode dot <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>DotNode<span style=color:#f92672>)</span> path<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>JoinType hibernateJoinType <span style=color:#f92672>=</span> JoinProcessor<span style=color:#f92672>.</span><span style=color:#a6e22e>toHibernateJoinType</span><span style=color:#f92672>(</span> joinType <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>dot<span style=color:#f92672>.</span><span style=color:#a6e22e>setJoinType</span><span style=color:#f92672>(</span> hibernateJoinType <span style=color:#f92672>);</span>    <span style=color:#75715e>// Tell the dot node about the join type.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dot<span style=color:#f92672>.</span><span style=color:#a6e22e>setFetch</span><span style=color:#f92672>(</span> fetch <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Generate an explicit join for the root dot node.   The implied joins will be collected and passed up
</span></span></span><span style=display:flex><span><span style=color:#75715e>// to the root dot node.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dot<span style=color:#f92672>.</span><span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> alias <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> alias<span style=color:#f92672>.</span><span style=color:#a6e22e>getText</span><span style=color:#f92672>()</span> <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 解析阶段
</span></span></span><span style=display:flex><span><span style=color:#75715e>// selectStatement -&gt; query -&gt; processQuery
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 上面的报错在此处  SelectClause.java #212
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> <span style=color:#f92672>!</span>fromElementsForLoad<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span> origin <span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>fromElementsForLoad<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span> fromElement<span style=color:#f92672>.</span><span style=color:#a6e22e>getFetchOrigin</span><span style=color:#f92672>()</span> <span style=color:#f92672>)</span> <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> QueryException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;query specified join fetching, but the owner &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;of the fetched association was not present in the select list &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;[&#34;</span> <span style=color:#f92672>+</span> fromElement<span style=color:#f92672>.</span><span style=color:#a6e22e>getDisplayText</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=03-版本---加上-where-条件筛选>03 版本 - 加上 WHERE 条件筛选<a hidden class=anchor aria-hidden=true href=#03-版本---加上-where-条件筛选>#</a></h2><p>创建一个新的单元测试，筛选一下 Join 条件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>multiQuery_03</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var query <span style=color:#f92672>=</span> BookJoinQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>authorName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Author_2&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    var spec <span style=color:#f92672>=</span> BookJoinSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>multiQuery_03</span><span style=color:#f92672>(</span>query<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var page <span style=color:#f92672>=</span> PageRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 5<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    var result <span style=color:#f92672>=</span> queryBySpecMethod<span style=color:#f92672>(</span>spec<span style=color:#f92672>,</span> page<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var givenAuthor <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span><span style=color:#a6e22e>getContent</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>).</span><span style=color:#a6e22e>getAuthor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    assertThat<span style=color:#f92672>(</span>givenAuthor<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>isEqualTo</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Author_2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>具体的连表查询条件如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> Specification<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>multiQuery_03</span><span style=color:#f92672>(</span>BookJoinQuery param<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>root<span style=color:#f92672>,</span> query<span style=color:#f92672>,</span> cb<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var predicates <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedList<span style=color:#f92672>&lt;</span>Predicate<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Long<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>query<span style=color:#f92672>.</span><span style=color:#a6e22e>getResultType</span><span style=color:#f92672>())</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>long</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>query<span style=color:#f92672>.</span><span style=color:#a6e22e>getResultType</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            root<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            root<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getBookPublishTime</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            predicates<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>.</span><span style=color:#a6e22e>equal</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;publishTime&#34;</span><span style=color:#f92672>),</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getBookPublishTime</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthorName</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            predicates<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>.</span><span style=color:#a6e22e>equal</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>),</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthorName</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getReviewScore</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            predicates<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>.</span><span style=color:#a6e22e>equal</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;score&#34;</span><span style=color:#f92672>),</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getReviewScore</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        query<span style=color:#f92672>.</span><span style=color:#a6e22e>where</span><span style=color:#f92672>(</span>predicates<span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Predicate<span style=color:#f92672>[</span>0<span style=color:#f92672>]));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> query<span style=color:#f92672>.</span><span style=color:#a6e22e>getRestriction</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>生成的查询语句如下，可以看到查询条件是拼接在 <code>WHERE</code> 部分</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> bookjoin0_.id           <span style=color:#66d9ef>as</span> id1_1_0_,
</span></span><span style=display:flex><span>       bookjoin_a1_.id         <span style=color:#66d9ef>as</span> id1_0_1_,
</span></span><span style=display:flex><span>       bookjoin_r2_.id         <span style=color:#66d9ef>as</span> id1_2_2_,
</span></span><span style=display:flex><span>       bookjoin0_.author_id    <span style=color:#66d9ef>as</span> author_i3_1_0_,
</span></span><span style=display:flex><span>       bookjoin0_.publish_time <span style=color:#66d9ef>as</span> publish_2_1_0_,
</span></span><span style=display:flex><span>       bookjoin0_.review_id    <span style=color:#66d9ef>as</span> review_i4_1_0_,
</span></span><span style=display:flex><span>       bookjoin_a1_.name       <span style=color:#66d9ef>as</span> name2_0_1_,
</span></span><span style=display:flex><span>       bookjoin_r2_.score      <span style=color:#66d9ef>as</span> score2_2_2_
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> book bookjoin0_
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>inner</span> <span style=color:#66d9ef>join</span> author bookjoin_a1_ <span style=color:#66d9ef>on</span> bookjoin0_.author_id <span style=color:#f92672>=</span> bookjoin_a1_.id
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>inner</span> <span style=color:#66d9ef>join</span> review bookjoin_r2_ <span style=color:#66d9ef>on</span> bookjoin0_.review_id <span style=color:#f92672>=</span> bookjoin_r2_.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> bookjoin_a1_.name <span style=color:#f92672>=</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>limit</span> <span style=color:#f92672>?</span>
</span></span></code></pre></div><p>如果我想要针对 <code>join</code> 的表进行 <code>on</code> 条件查询，应该怎么做呢？
下面来看下 04 版本。</p><h2 id=04-版本---加上-join-on-条件筛选>04 版本 - 加上 JOIN ON 条件筛选<a hidden class=anchor aria-hidden=true href=#04-版本---加上-join-on-条件筛选>#</a></h2><p>创建一个新的单元测试</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>multiQuery_04</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    var query <span style=color:#f92672>=</span> BookJoinQuery<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>authorName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Author_2&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>reviewScore</span><span style=color:#f92672>(</span>70<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    var spec <span style=color:#f92672>=</span> BookJoinSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>multiQuery_04</span><span style=color:#f92672>(</span>query<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    var page <span style=color:#f92672>=</span> PageRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 5<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    var bookJoin <span style=color:#f92672>=</span> queryBySpecMethod<span style=color:#f92672>(</span>spec<span style=color:#f92672>,</span> page<span style=color:#f92672>).</span><span style=color:#a6e22e>getContent</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    assertThat<span style=color:#f92672>(</span>bookJoin<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthor</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>isEqualTo</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Author_2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    assertThat<span style=color:#f92672>(</span>bookJoin<span style=color:#f92672>.</span><span style=color:#a6e22e>getReview</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getScore</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>isEqualTo</span><span style=color:#f92672>(</span>70<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先直接对 <code>join</code> 条件进行 <code>on</code> 查询</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>static</span> Specification<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>multiQuery_04</span><span style=color:#f92672>(</span>BookJoinQuery param<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>root<span style=color:#f92672>,</span> query<span style=color:#f92672>,</span> cb<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getBookPublishTime</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            query<span style=color:#f92672>.</span><span style=color:#a6e22e>where</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>.</span><span style=color:#a6e22e>equal</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;publishTime&#34;</span><span style=color:#f92672>),</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getBookPublishTime</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthorName</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Join<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> author <span style=color:#f92672>=</span> root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            author<span style=color:#f92672>.</span><span style=color:#a6e22e>on</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>.</span><span style=color:#a6e22e>equal</span><span style=color:#f92672>(</span>author<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>),</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthorName</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getReviewScore</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Join<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> review <span style=color:#f92672>=</span> root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;review&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            review<span style=color:#f92672>.</span><span style=color:#a6e22e>on</span><span style=color:#f92672>(</span>cb<span style=color:#f92672>.</span><span style=color:#a6e22e>equal</span><span style=color:#f92672>(</span>review<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;score&#34;</span><span style=color:#f92672>),</span> param<span style=color:#f92672>.</span><span style=color:#a6e22e>getReviewScore</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> query<span style=color:#f92672>.</span><span style=color:#a6e22e>getRestriction</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>此时生成的 SQL 语句如下，能够成功拼接 JOIN ON 条件但是出现 N + 1 问题，</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> bookjoin0_.id           <span style=color:#66d9ef>as</span> id1_1_,
</span></span><span style=display:flex><span>       bookjoin0_.author_id    <span style=color:#66d9ef>as</span> author_i3_1_,
</span></span><span style=display:flex><span>       bookjoin0_.publish_time <span style=color:#66d9ef>as</span> publish_2_1_,
</span></span><span style=display:flex><span>       bookjoin0_.review_id    <span style=color:#66d9ef>as</span> review_i4_1_
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> book bookjoin0_
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>inner</span> <span style=color:#66d9ef>join</span> author bookjoin_a1_ <span style=color:#66d9ef>on</span> bookjoin0_.author_id <span style=color:#f92672>=</span> bookjoin_a1_.id <span style=color:#66d9ef>and</span> (bookjoin_a1_.name <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>inner</span> <span style=color:#66d9ef>join</span> review bookjoin_r2_ <span style=color:#66d9ef>on</span> bookjoin0_.review_id <span style=color:#f92672>=</span> bookjoin_r2_.id <span style=color:#66d9ef>and</span> (bookjoin_r2_.score <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>) <span style=color:#66d9ef>limit</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> bookjoin_a0_.id <span style=color:#66d9ef>as</span> id1_0_0_, bookjoin_a0_.name <span style=color:#66d9ef>as</span> name2_0_0_
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> author bookjoin_a0_
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> bookjoin_a0_.id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> bookjoin_r0_.id <span style=color:#66d9ef>as</span> id1_2_0_, bookjoin_r0_.score <span style=color:#66d9ef>as</span> score2_2_0_
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> review bookjoin_r0_
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> bookjoin_r0_.id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span></code></pre></div><p>此时如果我们改用 <code>fetch</code> 的话，又不能进行 <code>on</code> 条件筛选，该怎么处理呢？</p><p>这里的解决方案是引入一个新的注解 <code>@EntityGraph</code>，修改我们的查询方法</p><ul><li>主动声明查询方法返回的 Entity 明确需要进行 Fetch 的属性有哪些</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EntityGraph</span><span style=color:#f92672>(</span>attributePaths <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;review&#34;</span> <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findAll</span><span style=color:#f92672>(</span>Specification<span style=color:#f92672>&lt;</span>BookJoin<span style=color:#f92672>&gt;</span> spec<span style=color:#f92672>,</span> Pageable pageable<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>再看一下生成的语句，很好，自动帮忙 fetch 出来了，并且也解决了 02 版本的分页查询问题</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> bookjoin0_.id           <span style=color:#66d9ef>as</span> id1_1_0_,
</span></span><span style=display:flex><span>       bookjoin_a1_.id         <span style=color:#66d9ef>as</span> id1_0_1_,
</span></span><span style=display:flex><span>       bookjoin_r2_.id         <span style=color:#66d9ef>as</span> id1_2_2_,
</span></span><span style=display:flex><span>       bookjoin0_.author_id    <span style=color:#66d9ef>as</span> author_i3_1_0_,
</span></span><span style=display:flex><span>       bookjoin0_.publish_time <span style=color:#66d9ef>as</span> publish_2_1_0_,
</span></span><span style=display:flex><span>       bookjoin0_.review_id    <span style=color:#66d9ef>as</span> review_i4_1_0_,
</span></span><span style=display:flex><span>       bookjoin_a1_.name       <span style=color:#66d9ef>as</span> name2_0_1_,
</span></span><span style=display:flex><span>       bookjoin_r2_.score      <span style=color:#66d9ef>as</span> score2_2_2_
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> book bookjoin0_
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>inner</span> <span style=color:#66d9ef>join</span> author bookjoin_a1_ <span style=color:#66d9ef>on</span> bookjoin0_.author_id <span style=color:#f92672>=</span> bookjoin_a1_.id <span style=color:#66d9ef>and</span> (bookjoin_a1_.name <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>inner</span> <span style=color:#66d9ef>join</span> review bookjoin_r2_ <span style=color:#66d9ef>on</span> bookjoin0_.review_id <span style=color:#f92672>=</span> bookjoin_r2_.id <span style=color:#66d9ef>and</span> (bookjoin_r2_.score <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>) <span style=color:#66d9ef>limit</span> <span style=color:#f92672>?</span>
</span></span></code></pre></div><h2 id=注意-1>注意<a hidden class=anchor aria-hidden=true href=#注意-1>#</a></h2><p>上面使用的示例是针对【强一对一关系】所以使用默认的连接类型 <code>INNER JOIN</code></p><p>当然也可以使用左外连接（右外连接不支持）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>,</span> JoinType<span style=color:#f92672>.</span><span style=color:#a6e22e>LEFT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;author&#34;</span><span style=color:#f92672>,</span> JoinType<span style=color:#f92672>.</span><span style=color:#a6e22e>LEFT</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><h1 id=扩展阅读>扩展阅读<a hidden class=anchor aria-hidden=true href=#扩展阅读>#</a></h1><ul><li><a href=https://spring.io/blog/2011/04/26/advanced-spring-data-jpa-specifications-and-querydsl>Advanced Spring Data JPA - Specifications and Querydsl</a></li><li><a href=https://www.baeldung.com/rest-api-search-language-spring-data-specifications>REST Query Language with Spring Data JPA Specifications</a></li><li><a href=https://github.com/consoleau/kotlin-jpa-specification-dsl>Spring Data JPA Specification DSL for Kotlin</a></li></ul><h1 id=-链接>🔗 链接<a hidden class=anchor aria-hidden=true href=#-链接>#</a></h1><ul><li><a href=https://github.com/lexcao/spring-data-jpa-join-table>Github source</a></li><li><a href=https://www.jianshu.com/p/659e9715d01d>Spring Data JPA使用Specification</a></li></ul><h1 id=总结>👀总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h1><ul><li>使用 SpringJPA 来写动态多条件连表查询，通过代码来控制 SQL 语句，需要对 JPA 以及 Hibernate 相关 API 相对熟练才可以写出优质的 SQL 语句生成。</li><li>和 MyBatis 可以直接拼接 SQL 的相比，各有应用场景。</li><li>整体来说用代码来写 JPA 的动态查询，对于习惯 SQL 语句的人来说，还是感觉隔了一层。</li><li>对于这样的分页连表查询，个人感觉还是 MyBatis 舒服一点，简单。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://lexcao.io/zh/tags/java/>Java</a></li><li><a href=https://lexcao.io/zh/tags/kotlin/>Kotlin</a></li><li><a href=https://lexcao.io/zh/tags/spring/>Spring</a></li><li><a href=https://lexcao.io/zh/tags/jpa/>JPA</a></li></ul><nav class=paginav><a class=prev href=https://lexcao.io/zh/posts/spring-data-jpa-join-table-best-practice/><span class=title>« 上一页</span><br><span>Spring Data JPA 多条件连表查询最佳实践</span></a>
<a class=next href=https://lexcao.io/zh/posts/learn-rust-fullstack/><span class=title>下一页 »</span><br><span>通过构建全栈待办应用学习 Rust</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://lexcao.io/zh/>The Coding Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function s(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>